# Add telemetry agent functions to your Aira instance  
Aira source package to input data from sensors. ROS-enabled telemetry agent

# Модуль для вашего экземлпяра Aira. Добавьте функции агента телеметрии.
Набор программного кода для Aira, позволяющий считывать данные от сенсоров и публиковать в ROS топики. Таким образом Аира может использовать собираемые данные для формирования спроса, предложения и результата по выполненному обязательству. Также в экспериментальном режиме добавлена функция отправки хэша собранных данных в Substrate Blockchain с использованием функции datalog.  

## Get a Package And Build

Assuming you work under [AIRA](https://wiki.robonomics.network/docs/aira-installation-on-vb/) do the following:

```
su - liability
git clone https://github.com/airalab/sensors-connectivity
cd sensors-connectivity
nix build -f release.nix
```

## Configuration

Basically you can think of the package as a black box with one input (sensor data) and many outputs.
For now only SDS011 sensor is supported but if you are familiar with Python it'd be easy to add other sensors as well.

Have a look at [configuration](config/default.yaml) file:

```yaml
# Please DO NOT edit this file
# Make a copy instead, make changes and pass the absolute path to the copy in arguments
general:
  port: "/dev/ttyUSB0"  # COM port of the device
  read-interval: 300    # time between two measurements in seconds
  geo: ""               # Geo coordinates as latitude,longitude
luftdaten:
  enable: true          # whether or not publish to https://luftdaten.info/
robonomics:
  enable: true          # enable use of Robonomics Network
  result: true          # publish Result message
  demand: false         # publish Demand message
  model: ""             # Agent's model (IPFS hash)
  token: ""             # Ethereum address of ERC20 token
  lighthouse: ""        # Name of lighthouse, e.g. airalab.lighthouse.5.robonomics.eth
  validator: "0x0000000000000000000000000000000000000000"
  validatorFee: 0
datalog:
  enable: false         # enable use of Datalog Robonomics subcommand
  path: ""              # path to Robonomics execution file
  suri: ""              # private key of publisher account
  remote: "wss://substrate.ipci.io"
  dump-interval: 3600   # time between two transactions in seconds
dev:
  sentry: ""
```

At the moment it's possible to publish data to [Luftdaten](https://luftdaten.info/), [Robonomics Network](https://robonomics.network/) and [Datalog](https://github.com/airalab/robonomics).
The last one is experimental!

> DO NOT edit `config/default.yaml` file. Instead make a copy

Play around with the configuration!

## Launch

> **Add use liability to open port `/dev/ttyUSB0` for service**
>
> Most probably a user liability is not in the dialout group
>
> Either do `sudo adduser liability dialout` or add the line to `/etc/nixos/configuration.nix` on NixOS:
> `users.users.liability.extraGroups = [ "dialout" ];`

When you feel ready to start the program do:

```
source result/setup.bash
roslaunch sensors_connectivity agent.launch config:=PATH
```

where `PATH` is the absolute path to your configuration yaml file

## Make a Service

It's way more convenient to launch the code as a systemd service. Add the following in `/etc/nixos/configuration.nix`:

```
systemd.services.connectivity = {
    requires = [ "roscore.service" ];
    after = ["roscore.service" ];
    wantedBy = [ "multi-user.target" ];
    environment.ROS_MASTER_URI =  "http://localhost:11311";
    script = ''
        source /var/lib/liability/sensors-connectivity/result/setup.bash \
        && roslaunch sensors_connectivity agent.launch config:=/var/lib/liability/sensors-connectivity/config/default.yaml
    '';
    serviceConfig = {
        Restart = "on-failure";
        StartLimitInterval = 0;
        RestartSec = 60;
        User = "liability";
    };
};
```

Technically it's not necessary to specify the `default.yaml` configuration file, but if you did changes please put the absolute path to `config` parameter.

After that run `nixos-rebuild switch`. The service should be up and running

## Check Your Connectivity Service 

Usually log files are stored in `/var/lib/liability/.ros/log/latest//connectivity-worker-1.log`
To view logs do:
```
tail -f /var/lib/liability/.ros/log/latest//connectivity-worker-1.log
```

Also you can use `journalctl` but remember output is buffered so it could take some time before output appears
```
journalctl -u connectivity -f
```
