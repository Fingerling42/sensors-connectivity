# Add telemetry agent functions to your Aira instance
Aira source package to input data from sensors. ROS-enabled telemetry agent

# Module For Your Aira Instance. Add Telemetry Agent

The Aira package allows you to read data from a SDS011 sensor and publish to different output channels.
That said Aira is able to form Demand and Result messages and a few other channels.
Also it includes Datalog feature which is still experimental. It could be used to publish data to Substrate based blockchain by Robonomics.

## Get a Package And Build

Assuming you work under [AIRA](https://wiki.robonomics.network/docs/aira-installation-on-vb/) do the following:

```
su - liability
git clone https://github.com/airalab/sensors-connectivity
cd sensors-connectivity
nix build -f release.nix
```

## Configuration

Basically you can think of the package as a black box with one input (sensor data) and many outputs.
For now only SDS011 sensor is supported but if you are familiar with Python it'd be easy to add other sensors as well.

Have a look at [configuration](config/default.yaml) file:

```yaml
# Please DO NOT edit this file
# Make a copy instead, make changes and pass the absolute path to the copy in arguments
general:
  publish_interval: 300 # time between two published messages
comstation:
  port: "/dev/ttyUSB0"  # COM port of the device
  work_period: 300      # time between two measurements in seconds
  geo: ""               # Geo coordinates as latitude,longitude
  public_key: ""        # If not provided, COMStation creates itself
tcpstation:
  address: ""           # IP and PORT to listen to, for example 0.0.0.0:31313
  acl:                  # list of known addresses. If not specified accepts from everyone
  # -
  # -
luftdaten:
  enable: true          # whether or not publish to https://luftdaten.info/
robonomics:
  enable: true          # enable use of Robonomics Network
  ipfs_provider: ""     # ipfs endpoint
  ipfs_topic: "airalab.lighthouse.5.robonomics.eth"
datalog:
  enable: false         # enable use of Datalog Robonomics subcommand
  path: ""              # path to Robonomics execution file
  suri: ""              # private key of publisher account
  remote: "wss://substrate.ipci.io"
  dump_interval: 3600   # time between two transactions in seconds
dev:
  sentry: ""
```

At the moment it's possible to publish data to [Luftdaten](https://luftdaten.info/), [Robonomics Network](https://robonomics.network/) and [Datalog](https://github.com/airalab/robonomics).
The last one is experimental!

> DO NOT edit `config/default.yaml` file. Instead make a copy

Play around with the configuration!

## ESP Firmware

There is a firmware for ESP8266-like boards in [boards/esp/ESP_TCP](boards/esp/ESP_TCP/ESP_TCP.ino)

Check out the following [README.md](boards/README.md) to connect your board

## Launch

> **Allow liability user to open port `/dev/ttyUSB0`**
>
> Most probably a user liability is not in the dialout group
>
> Either do `sudo adduser liability dialout` or add the line to `/etc/nixos/configuration.nix` on NixOS:
> `users.users.liability.extraGroups = [ "dialout" ];`

When you feel ready to start the program do:

```
source result/setup.bash
roslaunch sensors_connectivity agent.launch config:=PATH
```

where `PATH` is the absolute path to your configuration yaml file

## Make a Service

It's way more convenient to launch the code as a systemd service. Add the following in `/etc/nixos/configuration.nix`:

```
systemd.services.connectivity = {
    requires = [ "roscore.service" ];
    after = ["roscore.service" ];
    wantedBy = [ "multi-user.target" ];
    environment.ROS_MASTER_URI =  "http://localhost:11311";
    script = ''
        source /var/lib/liability/sensors-connectivity/result/setup.bash \
        && roslaunch sensors_connectivity agent.launch config:=/var/lib/liability/sensors-connectivity/config/default.yaml
    '';
    serviceConfig = {
        Restart = "on-failure";
        StartLimitInterval = 0;
        RestartSec = 60;
        User = "liability";
    };
};
```

Technically it's not necessary to specify the `default.yaml` configuration file, but if you did changes please put the absolute path to `config` parameter.

After that run `nixos-rebuild switch`. The service should be up and running

## Check Your Connectivity Service 

Usually log files are stored in `/var/lib/liability/.ros/log/latest//connectivity-worker-1.log`
To view logs do:
```
tail -f /var/lib/liability/.ros/log/latest//connectivity-worker-1.log
```

Also you can use `journalctl` but remember output is buffered so it could take some time before output appears
```
journalctl -u connectivity -f
```

Example of output:
```bash
root@hq-nuc-sds011> tail -f /var/lib/liability/.ros/log/latest/connectivity-worker-1.log                                                  ~
[rosout][INFO] 2020-05-01 19:13:43,337: Sending data...
[rosout][INFO] 2020-05-01 19:13:43,693: Response 201
[rosout][INFO] 2020-05-01 19:13:43,699: RobonomicsFeeder:
[rosout][INFO] 2020-05-01 19:13:45,517: Result published: QmceqYdyJCWhJDBgjcidyWeaZkg9e6VDExavNEY4WRtXvb
[rosout][INFO] 2020-05-01 19:18:45,520: Starting process...
[rosout][INFO] 2020-05-01 19:18:45,628: Station Data: {MAC: 94c6911b42d6, Uptime: 0:25:11.705348, M: {PM2.5: 1.4, PM10: 8.6}}
[rosout][INFO] 2020-05-01 19:18:45,633: Sending data...
[rosout][INFO] 2020-05-01 19:18:45,986: Response 201
[rosout][INFO] 2020-05-01 19:18:45,990: RobonomicsFeeder:
[rosout][INFO] 2020-05-01 19:18:47,870: Result published: QmXMuyyRd1YrUgw25nfX1ygk8tT8KU72BadMEgG6SbiqG5
```
